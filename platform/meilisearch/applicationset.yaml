apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: meilisearch
  namespace: argocd
  labels:
    app.kubernetes.io/part-of: platform
    app.kubernetes.io/component: search
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - list:
        elements:
          - env: dev
            service:
              hostname: dev.search.typie.io
            resources:
              cpu: 200m
              memory: 1Gi
            storage:
              size: 10Gi
            dumpUid: "20260226-070401550"

          - env: prod
            service:
              hostname: search.typie.io
            resources:
              cpu: 500m
              memory: 4Gi
            storage:
              size: 20Gi
            dumpUid: "20260226-070043545"

  template:
    metadata:
      name: meilisearch-{{.env}}
      labels:
        app.kubernetes.io/part-of: platform
        app.kubernetes.io/component: search
        app.kubernetes.io/instance: "{{.env}}"
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      sources:
        - chart: meilisearch
          repoURL: https://meilisearch.github.io/meilisearch-kubernetes
          targetRevision: 0.25.1
          helm:
            releaseName: meilisearch
            valuesObject:
              image:
                tag: v1.36.0

              resources:
                requests:
                  cpu: "{{.resources.cpu}}"
                limits:
                  memory: "{{.resources.memory}}"

              auth:
                existingMasterKeySecret: meilisearch-master-key

              environment:
                MEILI_ENV: production
                MEILI_IMPORT_DUMP: /meili_data/dumps/{{.dumpUid}}.dump
                MEILI_IGNORE_MISSING_DUMP: "true"

              service:
                annotations:
                  external-dns.typie.io/enabled: "true"
                  external-dns.alpha.kubernetes.io/internal-hostname: "{{.service.hostname}}"

              persistence:
                enabled: true
                storageClass: local-path
                size: "{{.storage.size}}"

              startupProbe:
                failureThreshold: 600

              initContainers:
                - name: prepare-import
                  image: busybox
                  command:
                    - sh
                    - -c
                    - |
                      DUMP="/meili_data/dumps/{{.dumpUid}}.dump"
                      if [ -f "$DUMP" ]; then
                        echo "Dump file found, removing data.ms for clean import"
                        rm -rf /meili_data/data.ms
                      fi
                  volumeMounts:
                    - name: data
                      mountPath: /meili_data

        - repoURL: https://github.com/penxle/kube
          targetRevision: HEAD
          path: platform/meilisearch/{{.env}}

      destination:
        server: https://kubernetes.default.svc
        namespace: "{{.env}}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - ServerSideApply=true
          - CreateNamespace=true
